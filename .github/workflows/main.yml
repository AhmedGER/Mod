# .github/workflows/build-combat-mod.yml
name: Build Combat Mod from Scratch

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  create-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3
      with:
        gradle-version: '8.5'
    
    - name: Create project structure
      run: |
        mkdir -p src/main/java/com/example/combat/{mixin,config}
        mkdir -p src/main/resources
        mkdir -p .github/workflows
    
    - name: Create build.gradle
      run: |
        cat > build.gradle << 'EOF'
        plugins {
            id 'fabric-loom' version '1.6-SNAPSHOT'
            id 'maven-publish'
        }

        version = project.mod_version
        group = project.maven_group

        base {
            archivesName = project.archives_base_name
        }

        repositories {
            mavenCentral()
            maven { url "https://maven.fabricmc.net/" }
        }

        dependencies {
            minecraft "com.mojang:minecraft:${project.minecraft_version}"
            mappings "net.fabricmc:yarn:${project.yarn_mappings}:v2"
            modImplementation "net.fabricmc:fabric-loader:${project.loader_version}"
            modImplementation "net.fabricmc.fabric-api:fabric-api:${project.fabric_version}"
            
            implementation 'com.google.code.gson:gson:2.10.1'
        }

        processResources {
            inputs.property "version", project.version
            
            filesMatching("fabric.mod.json") {
                expand "version": project.version
            }
        }

        tasks.withType(JavaCompile).configureEach {
            it.options.release = 8
        }

        java {
            withSourcesJar()
            
            sourceCompatibility = JavaVersion.VERSION_1_8
            targetCompatibility = JavaVersion.VERSION_1_8
        }

        jar {
            from("LICENSE") {
                rename { "${it}_${project.base.archivesName.get()}"}
            }
        }
        EOF
    
    - name: Create gradle.properties
      run: |
        cat > gradle.properties << 'EOF'
        org.gradle.jvmargs=-Xmx2G

        minecraft_version=1.16.5
        yarn_mappings=1.16.5+build.10
        loader_version=0.14.22

        maven_group=com.example
        archives_base_name=combat-mod
        mod_version=2.0.0

        fabric_version=0.42.0+1.16
        EOF
    
    - name: Create settings.gradle
      run: |
        cat > settings.gradle << 'EOF'
        pluginManagement {
            repositories {
                maven {
                    name = 'Fabric'
                    url = 'https://maven.fabricmc.net/'
                }
                gradlePluginPortal()
            }
        }

        rootProject.name = 'combat-mod'
        EOF
    
    - name: Create CombatMod.java
      run: |
        cat > src/main/java/com/example/combat/CombatMod.java << 'EOF'
        package com.example.combat;

        import com.example.combat.config.CombatConfig;
        import net.fabricmc.api.ClientModInitializer;
        import net.fabricmc.fabric.api.client.keybinding.v1.KeyBindingHelper;
        import net.minecraft.client.option.KeyBinding;
        import net.minecraft.client.util.InputUtil;
        import org.lwjgl.glfw.GLFW;

        public class CombatMod implements ClientModInitializer {
            public static final String MOD_ID = "combat";
            public static CombatConfig config = new CombatConfig();
            public static KeyBinding toggleKey;
            public static KeyBinding configKey;
            public static boolean enabled = true;
            public static int attackDelay = 0;
            
            @Override
            public void onInitializeClient() {
                config.load();
                
                toggleKey = KeyBindingHelper.registerKeyBinding(new KeyBinding(
                    "key.combat.toggle",
                    InputUtil.Type.KEYSYM,
                    GLFW.GLFW_KEY_R,
                    "category.combat"
                ));
                
                configKey = KeyBindingHelper.registerKeyBinding(new KeyBinding(
                    "key.combat.config",
                    InputUtil.Type.KEYSYM,
                    GLFW.GLFW_KEY_RIGHT_SHIFT,
                    "category.combat"
                ));
                
                System.out.println("[Combat Mod] Loaded! Press R=Toggle, RShift=Config");
            }
        }
        EOF
    
    - name: Create CombatConfig.java
      run: |
        cat > src/main/java/com/example/combat/config/CombatConfig.java << 'EOF'
        package com.example.combat.config;

        import com.google.gson.Gson;
        import com.google.gson.GsonBuilder;
        import java.io.*;
        import java.nio.file.*;

        public class CombatConfig {
            public boolean autoAttack = true;
            public boolean autoAim = true;
            public double range = 4.5;
            public int attackSpeed = 2;
            
            private static final Gson GSON = new GsonBuilder().setPrettyPrinting().create();
            private static final Path CONFIG_PATH = Paths.get("config", "combat-mod.json");
            
            public void load() {
                try {
                    if (Files.exists(CONFIG_PATH)) {
                        String json = new String(Files.readAllBytes(CONFIG_PATH));
                        CombatConfig loaded = GSON.fromJson(json, CombatConfig.class);
                        this.autoAttack = loaded.autoAttack;
                        this.autoAim = loaded.autoAim;
                        this.range = loaded.range;
                        this.attackSpeed = loaded.attackSpeed;
                    }
                } catch (Exception e) {
                    System.err.println("Failed to load config: " + e.getMessage());
                }
            }
            
            public void save() {
                try {
                    Files.createDirectories(CONFIG_PATH.getParent());
                    String json = GSON.toJson(this);
                    Files.write(CONFIG_PATH, json.getBytes());
                } catch (Exception e) {
                    System.err.println("Failed to save config: " + e.getMessage());
                }
            }
        }
        EOF
    
    - name: Create ClientPlayerEntityMixin.java
      run: |
        cat > src/main/java/com/example/combat/mixin/ClientPlayerEntityMixin.java << 'EOF'
        package com.example.combat.mixin;

        import com.example.combat.CombatMod;
        import net.minecraft.client.MinecraftClient;
        import net.minecraft.client.network.ClientPlayerEntity;
        import net.minecraft.entity.Entity;
        import net.minecraft.entity.LivingEntity;
        import net.minecraft.text.LiteralText;
        import net.minecraft.util.Hand;
        import net.minecraft.util.math.Vec3d;
        import org.spongepowered.asm.mixin.Mixin;
        import org.spongepowered.asm.mixin.injection.At;
        import org.spongepowered.asm.mixin.injection.Inject;
        import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;

        @Mixin(ClientPlayerEntity.class)
        public class ClientPlayerEntityMixin {
            @Inject(method = "tick", at = @At("HEAD"))
            private void onTick(CallbackInfo ci) {
                ClientPlayerEntity player = (ClientPlayerEntity)(Object)this;
                MinecraftClient client = MinecraftClient.getInstance();
                
                if (client.world == null) return;
                
                if (CombatMod.toggleKey.wasPressed()) {
                    CombatMod.enabled = !CombatMod.enabled;
                    player.sendMessage(new LiteralText("Combat: " + (CombatMod.enabled ? "§aON" : "§cOFF")), true);
                }
                
                if (!CombatMod.enabled) return;
                
                if (CombatMod.attackDelay > 0) {
                    CombatMod.attackDelay--;
                    return;
                }
                
                Entity target = null;
                double closestDist = CombatMod.config.range;
                
                for (Entity e : client.world.getEntities()) {
                    if (!(e instanceof LivingEntity)) continue;
                    if (e == player) continue;
                    if (e.isSpectator()) continue;
                    
                    LivingEntity le = (LivingEntity)e;
                    if (le.getHealth() <= 0) continue;
                    
                    double dist = player.distanceTo(e);
                    if (dist < closestDist) {
                        closestDist = dist;
                        target = e;
                    }
                }
                
                if (target != null) {
                    if (CombatMod.config.autoAim) {
                        Vec3d targetPos = target.getPos().add(0, target.getHeight() * 0.5, 0);
                        Vec3d playerPos = player.getPos().add(0, player.getStandingEyeHeight(), 0);
                        Vec3d direction = targetPos.subtract(playerPos).normalize();
                        
                        double yaw = Math.toDegrees(Math.atan2(direction.z, direction.x)) - 90;
                        double pitch = -Math.toDegrees(Math.asin(direction.y));
                        
                        player.yaw = (float)yaw;
                        player.pitch = (float)pitch;
                    }
                    
                    if (CombatMod.config.autoAttack && client.interactionManager != null) {
                        client.interactionManager.attackEntity(player, target);
                        player.swingHand(Hand.MAIN_HAND);
                        CombatMod.attackDelay = CombatMod.config.attackSpeed;
                    }
                }
            }
        }
        EOF
    
    - name: Create fabric.mod.json
      run: |
        cat > src/main/resources/fabric.mod.json << 'EOF'
        {
          "schemaVersion": 1,
          "id": "combat",
          "version": "2.0.0",
          "name": "Combat Mod",
          "description": "Killaura with Config - R=Toggle, RShift=Config",
          "authors": ["AutoBuilder"],
          "license": "MIT",
          "environment": "client",
          "entrypoints": {
            "client": ["com.example.combat.CombatMod"]
          },
          "mixins": ["combat.mixins.json"],
          "depends": {
            "fabricloader": ">=0.14.0",
            "fabric": "*",
            "minecraft": "1.16.5",
            "java": ">=8"
          }
        }
        EOF
    
    - name: Create combat.mixins.json
      run: |
        cat > src/main/resources/combat.mixins.json << 'EOF'
        {
          "required": true,
          "minVersion": "0.8",
          "package": "com.example.combat.mixin",
          "compatibilityLevel": "JAVA_8",
          "refmap": "combat-mod-refmap.json",
          "client": [
            "ClientPlayerEntityMixin"
          ],
          "injectors": {
            "defaultRequire": 1
          }
        }
        EOF
    
    - name: Create LICENSE file
      run: echo "MIT License - Feel free to use and modify" > LICENSE
    
    - name: Build with Gradle directly
      run: gradle clean build --no-daemon
    
    - name: Upload Mod JAR
      uses: actions/upload-artifact@v4
      with:
        name: combat-mod-jar
        path: build/libs/*.jar
        retention-days: 30
    
    - name: Commit generated files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "Add generated combat mod files" || exit 0
        git push
